name: CI/CD Java Spring Dinámico

on:
  push:
    branches:
      - main
#      - develop
  pull_request:
    branches:
      - main
#      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
#    # --- CORRECCIÓN 1: Definir los outputs correctamente ---
    env:
      REPO_NAME: ${{ github.event.repository.name }}
      JAVA_VERSION: 17
      APP_PORT: 8081
    outputs:
      VERSION: ${{ steps.get_version.outputs.VERSION }}
      JAR_NAME: ${{ steps.get_version.outputs.JAR_NAME }}
      IMAGE_NAME: ${{ steps.get_version.outputs.IMAGE_NAME }}

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar version de Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Obtener la Versión del Proyecto
        id: get_version
        run: |
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          REPO_ARTIFACT_ID="${{ env.REPO_NAME }}"
          FULL_JAR_NAME="$REPO_ARTIFACT_ID-$PROJECT_VERSION.jar"

          echo "VERSION=$PROJECT_VERSION" >> $GITHUB_ENV
          echo "FULL_JAR_NAME=$FULL_JAR_NAME" >> $GITHUB_ENV
          echo "DOCKER_IMAGE_NAME=$REPO_ARTIFACT_ID" >> $GITHUB_ENV

          echo "VERSION=$PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "JAR_NAME=$FULL_JAR_NAME" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=$REPO_ARTIFACT_ID" >> $GITHUB_OUTPUT
          
          echo "::notice::Versión detectada: $PROJECT_VERSION"

      - name: Compilar, Probar y Empaquetar
        run: mvn -B clean verify -Pcoverage

      # Paso Nuevo: Imprimir Cobertura en Consola
      - name: Imprimir Cobertura JaCoCo
        run: |
          echo "Coverage Report Summary:"
          awk -F, 'NR>1 {covered+=$4; missed+=$5} END {print "Instruction Coverage: " int((covered/(covered+missed))*100) "%"}' target/site/jacoco/jacoco.csv

#      - name: Análisis de Calidad (SonarCloud)
#        if: ${{ env.SONAR_TOKEN != '' }}
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: mvn -B sonar:sonar -Dsonar.projectKey=${{ env.REPO_NAME }}

      - name: Subir el JAR como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FULL_JAR_NAME }}
          path: target/${{ env.FULL_JAR_NAME }}

  integration-test:
    needs: build
    runs-on: ubuntu-latest

    env:
      # --- CORRECCIÓN 2: Acceso a los outputs del job 'build' ---
      VERSION: ${{ needs.build.outputs.VERSION }}
      FULL_JAR_NAME: ${{ needs.build.outputs.JAR_NAME }}
      DOCKER_IMAGE_NAME: ${{ needs.build.outputs.IMAGE_NAME }} # Ahora sí accede al output correcto

    steps:
      - name: Checkout del código (para Dockerfile y colección Postman)
        uses: actions/checkout@v4

      - name: Descargar el JAR
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.FULL_JAR_NAME }}

      - name: Preparar JAR para Docker
        run: |
          mkdir -p target
          mv ${{ env.FULL_JAR_NAME }} target/

      - name: Login en Docker Hub
        if: github.event_name != 'pull_request' && env.DOCKER_USERNAME != ''
        uses: docker/login-action@v3
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Construir y Empujar Imagen Docker
        uses: docker/build-push-action@v5
        with:
          context: .
#          push: ${{ github.event_name != 'pull_request' && secrets.DOCKER_USERNAME != '' }}
          push: false
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ env.VERSION }}
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Visualizar imágenes Docker locales
        run: docker images

      - name: Levantar el contenedor para Pruebas (Puerto 8081)
        id: container_run
        run: |
          docker run -d --name ${{ env.DOCKER_IMAGE_NAME }} -p 8081:8081 ${{ env.DOCKER_IMAGE_NAME }}:${{ env.VERSION }}

      - name: Instalar Node.js y Newman
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g newman

      - name: Esperar a que el Webservice esté listo
        run: sleep 40s

      - name: Ejecutar Pruebas de API (Postman)
        continue-on-error: true # No fallar el pipeline si no hay colección
        run: |
          if [ -f "./API_EMPLOYEE_DEVOPS.postman-collection.json" ]; then
            newman run ./API_EMPLOYEE_DEVOPS.postman-collection.json
          else
            echo "::warning::No se encontró postman-collection.json, saltando pruebas."
          fi

      - name: Limpieza
        if: always()
        run: docker rm -f ${{ env.DOCKER_IMAGE_NAME }}